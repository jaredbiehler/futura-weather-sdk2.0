<!DOCTYPE html>
<html>
<head>
    <title>Weather My Way Configuration</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css" />
    <style>
        #apikey { display: none;}
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script>
</head>
<body>
<div data-role="page" id="main">

    <div data-role="content" class="ui-body ui-body-a">

        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup" data-mini="true">
                <legend>Weather Provider:</legend>
                <input type="radio" name="weather-service" id="radioyahoo" value="yahoo" class="custom" />
                <label for="radioyahoo">YAHOO! Weather</label>

                <input type="radio" name="weather-service" id="radioopen" value="open" class="custom" />
                <label for="radioopen">Open Weather Map</label>

            </fieldset>
        </div>

        <div data-role="fieldcontain">
            <label for="fliphourly">Hourly Weather (requires key):</label>
            <select name="fliphourly" id="fliphourly" data-role="slider" data-mini="true">
                <option value="off">Off</option>
                <option value="on">On</option>
            </select>
        </div>
        <div data-role="popup" id="popupCloseRight" class="ui-content">
            <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
            <p>Hourly weather requires a Weather Underground API key.</p>
            <p>Weather Underground provides a free Developer API key, but you must first sign up.
                You can <a href="http://www.wunderground.com/weather/api/">sign up here.</a></p>
        </div>
        <div data-role="fieldcontain" id="apikey" data-mini="true">
            <div class="ui-field-contain" >
                <label for="text-apikey">Weather Underground API Key:</label>
                <input type="text" name="text-apikey"  id="text-apikey" autocapitalize="off" autocorrect="off" autocomplete="off" value="">
            </div>
        </div>
	
        <div data-role="fieldcontain" id="1stF">
            <label for="h1_offset">1st Hourly forecast </label>
            <select name="h1_offset" id="h1_offset" data-role="selector" data-mini="true">
                <option value="0">1 hour</option>
                <option value="1">2 hours</option>
                <option value="2">3 hours</option>
                <option value="3">4 hours</option>
                <option value="4">5 hours</option>
                <option value="5">6 hours</option>
                <option value="6">7 hours</option>
                <option value="7">8 hours</option>
                <option value="8">9 hours</option>
                <option value="9">10 hours</option>
                <option value="10">11 hours</option>
                <option value="11">12 hours</option>
                <option value="12">13 hours</option>
                <option value="13">14 hours</option>
                <option value="14">15 hours</option>
                <option value="15">16 hours</option>
                <option value="16">17 hours</option>
                <option value="17">18 hours</option>
                <option value="18">19 hours</option>
                <option value="19">20 hours</option>
                <option value="20">21 hours</option>
                <option value="21">22 hours</option>
                <option value="22">23 hours</option>
                <option value="23">24 hours</option>
            </select>
        </div>

        <div data-role="fieldcontain" id="2ndF">
            <label for="h2_offset">2nd Hourly forecast</label>
            <select name="h2_offset" id="h2_offset" data-role="selector" data-mini="true">
                <option value="0">1 hour</option>
                <option value="1">2 hours</option>
                <option value="2">3 hours</option>
                <option value="3">4 hours</option>
                <option value="4">5 hours</option>
                <option value="5">6 hours</option>
                <option value="6">7 hours</option>
                <option value="7">8 hours</option>
                <option value="8">9 hours</option>
                <option value="9">10 hours</option>
                <option value="10">11 hours</option>
                <option value="11">12 hours</option>
                <option value="12">13 hours</option>
                <option value="13">14 hours</option>
                <option value="14">15 hours</option>
                <option value="15">16 hours</option>
                <option value="16">17 hours</option>
                <option value="17">18 hours</option>
                <option value="18">19 hours</option>
                <option value="19">20 hours</option>
                <option value="20">21 hours</option>
                <option value="21">22 hours</option>
                <option value="22">23 hours</option>
                <option value="23">24 hours</option>
            </select>
        </div>

        <div data-role="fieldcontain" id="forecastAuto" >
            <label for="flipfeelslike">Use automatic forecasts:</label>
            <select name="flipautoforecast" id="flipautoforecast" data-role="slider" data-mini="true">
                <option value="off">Off</option>
                <option value="on">On</option>
            </select>
        </div>


        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
                <legend>Temperature Scale:</legend>
                <input type="radio" name="weather-scale" id="radioF" value="F" class="custom" />
                <label for="radioF">Imperial - °F</label>

                <input type="radio" name="weather-scale" id="radioC" value="C" class="custom" />
                <label for="radioC">Metric - °C</label>

            </fieldset>
        </div>

        <div data-role="fieldcontain" >
            <label for="flipfeelslike">Use Feels Like for Temps:</label>
            <select name="flipfeelslike" id="flipfeelslike" data-role="slider" data-mini="true">
                <option value="off">Off</option>
                <option value="on">On</option>
            </select>
        </div>


        <div data-role="fieldcontain">
            <label for="flipdebug">Debug Mode:</label>
            <select name="flipdebug" id="flipdebug" data-role="slider" data-mini="true">
                <option value="off">Off</option>
                <option value="on">On</option>
            </select>
        </div>

        <fieldset class="ui-grid-a">
            <div class="ui-block-a"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></div>
            <div class="ui-block-b"><button type="submit" data-theme="b" id="b-submit">Save</button></div>
        </fieldset>

    </div>
</div>
<script>
    function saveOptions() {
        return {
            'service': $("#radioyahoo").is(':checked') ? 'yahoo' : 'open',
            'scale':   $("#radioF").is(':checked')     ? 'F' : 'C',
            'feelslike': $("select[name=flipfeelslike]").prop('selectedIndex') ? 'on' : 'off',
            'battery': 'on',
            'debug':   $("select[name=flipdebug]").prop('selectedIndex')   ? 'true' : 'false',
            'h1_offset':   $("select[name=h1_offset]").prop('selectedIndex')  ,
            'h2_offset':   $("select[name=h2_offset]").prop('selectedIndex')  ,
            'autoforecast': $("select[name=flipautoforecast]").prop('selectedIndex') ? 'on' : 'off',
            'wuApiKey':$("select[name=fliphourly]").prop('selectedIndex')  ? $("#text-apikey").val() : null
        };
    }

    function getURLParameter(name) {
        return decodeURI(
                (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
        );
    }

    $().ready(function() {

        var initialLoad = true;

        var flipHourly = $("select[name=fliphourly]");
        flipHourly.bind( "change", function(event, ui) {
            var val = $(this).val();
            if (val === 'on') {
                $("#apikey").show();
		$("#h1_offset").show();
		$("#h2_offset").show();
		$("#1stF").show();
		$("#2ndF").show();
		$("#forecastAuto").show();
	        if (!initialLoad) {
                    $("#popupCloseRight").popup("open");
                }
            } else {
                $("#apikey").hide();
		$("#1stF").hide();
	        $("#2ndF").hide();
		$("#h1_offset").hide();
		$("#forecastAuto").hide();
		$("#h2_offset").hide();
		
            }
        });

        var service = getURLParameter('s');
        if (service === 'open') {
            $("#radioopen").attr("checked", "checked");
        } else {
            $("#radioyahoo").attr("checked", "checked");
        }
        $("input[name='weather-service']").checkboxradio("refresh");

        var scale = getURLParameter('u');
        if (scale === 'C') {
            $("#radioC").attr("checked", "checked");
        } else {
            $("#radioF").attr("checked", "checked");
        }
        $("input[name='weather-scale']").checkboxradio("refresh");

        var apikey = getURLParameter('a');
        if (apikey !== 'null') {
            flipHourly.prop('selectedIndex', 1);
            $("#text-apikey").val(apikey);
        } else {
            flipHourly.prop('selectedIndex', 0);
        }
        flipHourly.change();

	var selecth1 = $("select[name=h1_offset]");
        var h1 = getURLParameter('h1');
	selecth1.val(h1);
	
        var selecth2 = $("select[name=h2_offset]");
        var h2 = getURLParameter('h2');
        selecth2.val(h2);
	
        

        var flipFeelslike = $("select[name=flipfeelslike]");
        var feelslike = getURLParameter('f');
        if (feelslike === 'off') {
            flipFeelslike.prop('selectedIndex', 0);
        } else {
            flipFeelslike.prop('selectedIndex', 1);
        }
        var flipAutoForecast = $("select[name=flipautoforecast]");
	var af = getURLParameter('af');
	if (af === 'off') {
            flipAutoForecast.prop('selectedIndex', 0);
        } else {
            flipAutoForecast.prop('selectedIndex', 1);
        }
        
	var flipBattery = $("select[name=flipbattery]");
        var battery = getURLParameter('b');
        if (battery === 'off') {
            flipBattery.prop('selectedIndex', 0);
        } else {
            flipBattery.prop('selectedIndex', 1);
        }

        var flipDebug = $("select[name=flipdebug]");
        var debug = getURLParameter('d');
        if (debug === 'true') {
            flipDebug.prop('selectedIndex', 1);
        } else {
            flipDebug.prop('selectedIndex', 0);
        }

        $("select[name=h1_offset]").selectmenu("refresh",true);
        $("select[name=h2_offset]").selectmenu("refresh",true);
        $("select[name=flipfeelslike]").slider("refresh");
	$("select[name=flipdebug]").slider("refresh");
	$("select[name=flipbattery]").slider("refresh");
	$("select[name=flipautoforecast]").slider("refresh");
	
        $("#b-cancel").click(function() {
            console.log("Cancel");
            document.location = "pebblejs://close";
        });

        $("#b-submit").click(function() {
            console.log("Submit");

            var location = "pebblejs://close#" + (JSON.stringify(saveOptions()));
            console.log("Warping to: " + location);
            console.log(location);
            document.location = location;
        });

        initialLoad = false;
    });
</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50506231-1', 'jaredbiehler.github.io');
    ga('send', 'pageview');

</script>
</body>
</html>
